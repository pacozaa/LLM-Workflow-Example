name: Deploy to Azure

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  NODE_VERSION: '20.x'
  AZURE_RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP || 'llm-workflow-rg' }}
  POSTGRES_ADMIN_USERNAME: 'pgadmin'

jobs:
  deploy-infrastructure:
    name: Deploy Azure Infrastructure
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.ref == 'refs/heads/main')
    outputs:
      backend-url: ${{ steps.deploy-arm.outputs.backendUrl }}
      frontend-url: ${{ steps.deploy-arm.outputs.frontendUrl }}
      backend-app-name: ${{ steps.extract-names.outputs.backend-app-name }}
      frontend-app-name: ${{ steps.extract-names.outputs.frontend-app-name }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Create Resource Group
        run: |
          az group create \
            --name ${{ env.AZURE_RESOURCE_GROUP }} \
            --location eastus

      - name: Deploy ARM Template
        id: deploy-arm
        uses: azure/arm-deploy@v2
        with:
          resourceGroupName: ${{ env.AZURE_RESOURCE_GROUP }}
          template: ./docs/deployment/azure-template.json
          parameters: >
            projectName=llmworkflow
            location=eastus
            postgresAdminUsername=${{ env.POSTGRES_ADMIN_USERNAME }}
            postgresAdminPassword=${{ secrets.POSTGRES_ADMIN_PASSWORD }}
            openaiApiKey=${{ secrets.OPENAI_API_KEY }}
          deploymentName: azure-deploy-${{ github.run_number }}

      - name: Extract App Names
        id: extract-names
        run: |
          BACKEND_URL="${{ steps.deploy-arm.outputs.backendUrl }}"
          FRONTEND_URL="${{ steps.deploy-arm.outputs.frontendUrl }}"
          
          BACKEND_APP_NAME=$(echo $BACKEND_URL | sed 's|https://||' | sed 's|.azurewebsites.net||')
          FRONTEND_APP_NAME=$(echo $FRONTEND_URL | sed 's|https://||' | sed 's|.azurestaticapps.net||')
          
          echo "backend-app-name=$BACKEND_APP_NAME" >> $GITHUB_OUTPUT
          echo "frontend-app-name=$FRONTEND_APP_NAME" >> $GITHUB_OUTPUT
          
          echo "Backend App Name: $BACKEND_APP_NAME"
          echo "Frontend App Name: $FRONTEND_APP_NAME"

      - name: Output Deployment Info
        run: |
          echo "ðŸš€ Infrastructure Deployed Successfully!"
          echo "Backend URL: ${{ steps.deploy-arm.outputs.backendUrl }}"
          echo "Frontend URL: ${{ steps.deploy-arm.outputs.frontendUrl }}"
          echo "PostgreSQL Server: ${{ steps.deploy-arm.outputs.postgresServer }}"

  deploy-backend:
    name: Deploy Backend to Azure App Service
    runs-on: ubuntu-latest
    needs: deploy-infrastructure
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.ref == 'refs/heads/main')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          cd apps/backend
          npm ci

      - name: Build backend
        run: |
          cd apps/backend
          npm run build

      - name: Create deployment package
        run: |
          cd apps/backend
          zip -r ../../backend-deploy.zip dist package.json package-lock.json
          cd ../..

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy to Azure App Service
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ needs.deploy-infrastructure.outputs.backend-app-name }}
          package: ./backend-deploy.zip

      - name: Wait for backend to be ready
        run: |
          echo "Waiting for backend to start..."
          sleep 30
          
          BACKEND_URL="${{ needs.deploy-infrastructure.outputs.backend-url }}"
          MAX_ATTEMPTS=10
          ATTEMPT=1
          
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "Health check attempt $ATTEMPT of $MAX_ATTEMPTS..."
            
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$BACKEND_URL" || echo "000")
            
            if [ "$HTTP_CODE" -eq "200" ] || [ "$HTTP_CODE" -eq "404" ]; then
              echo "âœ… Backend is responding (HTTP $HTTP_CODE)"
              exit 0
            fi
            
            echo "Backend not ready yet (HTTP $HTTP_CODE), waiting..."
            sleep 15
            ATTEMPT=$((ATTEMPT + 1))
          done
          
          echo "âš ï¸ Backend health check inconclusive, but deployment completed"
          exit 0

      - name: Output Backend Status
        run: |
          echo "ðŸŽ‰ Backend Deployed Successfully!"
          echo "Backend URL: ${{ needs.deploy-infrastructure.outputs.backend-url }}"

  deploy-frontend:
    name: Deploy Frontend to Azure Static Web Apps
    runs-on: ubuntu-latest
    needs: [deploy-infrastructure, deploy-backend]
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.ref == 'refs/heads/main')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          cd apps/frontend
          npm ci

      - name: Build frontend
        env:
          VITE_API_URL: ${{ needs.deploy-infrastructure.outputs.backend-url }}
        run: |
          cd apps/frontend
          echo "VITE_API_URL=$VITE_API_URL" > .env.production
          npm run build

      - name: Deploy to Azure Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: 'upload'
          app_location: 'apps/frontend'
          output_location: 'dist'
          skip_app_build: true

      - name: Output Frontend Status
        run: |
          echo "ðŸŽ‰ Frontend Deployed Successfully!"
          echo "Frontend URL: ${{ needs.deploy-infrastructure.outputs.frontend-url }}"

  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy-infrastructure, deploy-backend, deploy-frontend]
    if: always() && (github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.ref == 'refs/heads/main'))
    
    steps:
      - name: Generate Summary
        run: |
          echo "# ðŸš€ Azure Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Deployment Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| Infrastructure | ${{ needs.deploy-infrastructure.result }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | ${{ needs.deploy-backend.result }} | ${{ needs.deploy-infrastructure.outputs.backend-url }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ${{ needs.deploy-frontend.result }} | ${{ needs.deploy-infrastructure.outputs.frontend-url }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Verify backend is running: ${{ needs.deploy-infrastructure.outputs.backend-url }}" >> $GITHUB_STEP_SUMMARY
          echo "2. Access the application: ${{ needs.deploy-infrastructure.outputs.frontend-url }}" >> $GITHUB_STEP_SUMMARY
          echo "3. Check logs if any issues occur" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment Time**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
